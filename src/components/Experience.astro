---
import Section from "./Section.astro";
import type { ExperienceProps } from "@types";

interface Props {
  experience: ExperienceProps[];
}

const { experience } = Astro.props;
---

<Section text="Work Experience" href="experience">
  <div class="relative">
    <!-- Timeline line -->
    <div class="absolute left-0 top-0 bottom-0 w-0.5 bg-gradient-to-b from-primary via-blue-500 to-transparent timeline-line hidden md:block"></div>

    {
      experience.map(({ company, position, startDate, endDate, summary }) => (
        <div class="mb-12 experience-item relative pl-0 md:pl-8">
          <!-- Timeline dot -->
          <div class="absolute left-0 top-6 w-3 h-3 bg-primary rounded-full border-4 border-bg timeline-dot hidden md:block -translate-x-[5px]"></div>

          <div class="group p-6 md:p-8 rounded-2xl border border-border bg-gradient-to-br from-card-bg to-transparent backdrop-blur-sm hover:border-primary/50 hover:shadow-2xl hover:shadow-primary/10 transition-all duration-500 experience-card">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-4">
              <div>
                <h3 class="text-2xl md:text-3xl font-serif font-semibold text-text mb-2 company-title group-hover:text-primary transition-colors duration-300">
                  {company}
                </h3>
                <h4 class="text-xl md:text-2xl font-serif text-primary font-medium mb-2 position-title">
                  {position}
                </h4>
              </div>
              <span class="text-sm text-secondary px-4 py-2 rounded-full bg-secondary/10 border border-border date-range inline-block md:ml-4">
                {startDate} â€” {endDate}
              </span>
            </div>

            {Array.isArray(summary) ? (
              <ul class="list-none summary-list space-y-3">
                {summary.map((log) => (
                  <li class="text-base relative text-secondary pl-8 summary-item hover:text-text transition-colors duration-300">
                    <span class="absolute left-0 top-1 text-secondary">
                       <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg">
                        <path d="M176.49,95.51a12,12,0,0,1,0,17l-56,56a12,12,0,0,1-17,0l-24-24a12,12,0,1,1,17-17L112,143l47.51-47.52A12,12,0,0,1,176.49,95.51ZM236,128A108,108,0,1,1,128,20,108.12,108.12,0,0,1,236,128Zm-24,0a84,84,0,1,0-84,84A84.09,84.09,0,0,0,212,128Z"></path>
                       </svg>
                    </span>
                    {log}
                  </li>
                ))}
              </ul>
            ) : (
              <p class="text-base text-secondary summary-text">{summary}</p>
            )}
          </div>
        </div>
      ))
    }
  </div>
</Section>

<script>
  async function initExperienceAnimation() {
    try {
      const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      if (prefersReducedMotion) return;

      const gsap = (await import('gsap')).default;
      const ScrollTrigger = (await import('gsap/ScrollTrigger')).default;

      gsap.registerPlugin(ScrollTrigger);

      // Ensure timeline line is visible
      const timelineLine = document.querySelector('.timeline-line');
      if (timelineLine) {
        gsap.set(timelineLine, { opacity: 1 });
        // Animate timeline line
        gsap.from('.timeline-line', {
          scrollTrigger: {
            trigger: '.timeline-line',
            start: "top 80%",
            end: "bottom 20%",
            scrub: 1
          },
          scaleY: 0,
          transformOrigin: "top",
          ease: "none"
        });
      }

      document.querySelectorAll('.experience-item').forEach((item, index) => {
        // Ensure all content is visible by default
        const card = item.querySelector('.experience-card');
        const dot = item.querySelector('.timeline-dot');
        const companyTitle = item.querySelector('.company-title');
        const positionTitle = item.querySelector('.position-title');
        const dateRange = item.querySelector('.date-range');
        const summaryItems = item.querySelectorAll('.summary-item');
        const summaryText = item.querySelector('.summary-text');

        if (card) gsap.set(card, { opacity: 1, scale: 1 });
        if (dot) gsap.set(dot, { opacity: 1, scale: 1 });
        if (companyTitle) gsap.set(companyTitle, { opacity: 1 });
        if (positionTitle) gsap.set(positionTitle, { opacity: 1 });
        if (dateRange) gsap.set(dateRange, { opacity: 1, scale: 1 });
        if (summaryItems.length) gsap.set(summaryItems, { opacity: 1 });
        if (summaryText) gsap.set(summaryText, { opacity: 1 });

        const tl = gsap.timeline({
          scrollTrigger: {
            trigger: item,
            start: "top 85%",
            toggleActions: "play none none reverse"
          }
        });

        // Card entrance with slide and scale
        if (card) {
          tl.from(card, {
            x: index % 2 === 0 ? -100 : 100,
            opacity: 0,
            scale: 0.9,
            duration: 0.8,
            ease: "power3.out"
          });
        }

        // Timeline dot pop
        if (dot) {
          tl.from(dot, {
            scale: 0,
            opacity: 0,
            duration: 0.4,
            ease: "back.out(2)"
          }, "-=0.4");
        }

        // Company title with fade and slide
        if (companyTitle) {
          tl.from(companyTitle, {
            y: 30,
            opacity: 0,
            duration: 0.6,
            ease: "power2.out"
          }, "-=0.5");
        }

        // Position title
        if (positionTitle) {
          tl.from(positionTitle, {
            y: 20,
            opacity: 0,
            duration: 0.5,
          }, "-=0.3");
        }

        // Date badge
        if (dateRange) {
          tl.from(dateRange, {
            scale: 0,
            opacity: 0,
            duration: 0.4,
            ease: "back.out(1.7)"
          }, "-=0.3");
        }

        // Animate summary items
        if (summaryItems.length) {
          tl.from(summaryItems, {
            x: -30,
            opacity: 0,
            duration: 0.4,
            stagger: 0.08,
            ease: "power2.out"
          }, "-=0.2");
        } else if (summaryText) {
          tl.from(summaryText, {
            y: 20,
            opacity: 0,
            duration: 0.4,
          }, "-=0.2");
        }

        // Optimized hover effects - removed 3D transforms for better performance
        if (card) {
          let hoverAnimation: gsap.core.Tween | null = null;
          
          card.addEventListener('mouseenter', function() {
            hoverAnimation = gsap.to(this, {
              y: -8,
              scale: 1.02,
              duration: 0.3,
              ease: "power2.out"
            });
          });

          card.addEventListener('mouseleave', function() {
            if (hoverAnimation) hoverAnimation.kill();
            gsap.to(this, {
              y: 0,
              scale: 1,
              duration: 0.3,
              ease: "power2.out"
            });
          });

          // Removed intensive 3D mousemove transforms
          // Added subtle parallax effect instead for better performance
          let mouseMoveTimeout: number | null = null;
          card.addEventListener('mousemove', function(e: MouseEvent) {
            if (mouseMoveTimeout) return;
            
            mouseMoveTimeout = window.setTimeout(() => {
              const rect = this.getBoundingClientRect();
              const x = e.clientX - rect.left;
              const y = e.clientY - rect.top;
              
              // Subtle shadow movement instead of 3D transforms
              const shadowX = ((x - rect.width / 2) / rect.width) * 10;
              const shadowY = ((y - rect.height / 2) / rect.height) * 10;
              
              (this as HTMLElement).style.boxShadow = `0 ${8 + shadowY}px ${32 + Math.abs(shadowX)}px rgba(59, 130, 246, 0.1)`;
              
              mouseMoveTimeout = null;
            }, 50); // Throttled to 20fps
          });
        }
      });
    } catch (error) {
      console.error('Experience animation failed:', error);
      // Ensure all experience content is visible
      const items = document.querySelectorAll('.experience-item');
      items.forEach(item => {
        const elements = item.querySelectorAll('.experience-card, .timeline-dot, .company-title, .position-title, .date-range, .summary-item, .summary-text');
        elements.forEach(el => {
          (el as HTMLElement).style.opacity = '1';
          (el as HTMLElement).style.visibility = 'visible';
        });
      });
    }
  }

  // Initialize immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initExperienceAnimation);
  } else {
    initExperienceAnimation();
  }
</script>

<style>
  .experience-card {
    transform-style: preserve-3d;
    will-change: transform;
  }

  .timeline-dot {
    box-shadow: 0 0 20px rgba(37, 99, 235, 0.5);
  }
</style>
