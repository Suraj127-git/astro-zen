---
import Section from "./Section.astro";
import { Image } from "astro:assets";
import type { ProjectProps } from "@types";

interface Props {
  blog: ProjectProps[];
}

const { blog } = Astro.props;
---

<Section text="Featured Blog" href="blog">
  {
    blog.map(({ name, summary, image, linkPreview }, index) => {
      const top = 98 + index * 40;
      return (
        <div
          style={`top: ${top}px;`}
          class="group sticky rounded-2xl border border-border bg-gradient-to-br from-card-bg to-transparent backdrop-blur-sm mb-12 blog-card overflow-hidden hover:border-primary/50 hover:shadow-2xl hover:shadow-primary/20 transition-all duration-500"
        >
          <div class="w-full h-[580px] md:h-[420px] relative z-[1] bg-overlay/85 before:content-[''] before:rounded-2xl before:absolute before:z-[-1] before:opacity-[5%] dark:before:opacity-[3%] before:inset-0 before:bg-[url(/raja.png)] before:bg-repeat before:bg-[length:128px] rounded-2xl grid grid-rows-2 sm:grid-rows-1 sm:grid-cols-2 overflow-hidden">
            <div class="px-6 md:px-8 pt-8 md:pt-12 blog-content flex flex-col justify-between">
              <div>
                <div class="mb-4 inline-block px-3 py-1 rounded-full bg-primary/10 border border-primary/30 text-primary text-xs font-medium">
                  BLOG POST {String(index + 1).padStart(2, '0')}
                </div>
                <h3 class="text-2xl md:text-3xl font-medium font-serif mb-4 text-text group-hover:text-primary transition-colors duration-300 blog-title">
                  {name}
                </h3>
                <p class="text-secondary text-sm md:text-base leading-relaxed blog-summary">{summary}</p>
              </div>
              <div class="pt-6">
                <a
                  href={linkPreview}
                  target="_blank"
                  class="group/link inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-primary/10 border border-primary/30 hover:bg-primary hover:border-primary text-primary hover:text-white transition-all duration-300 text-sm font-medium blog-link"
                >
                  <span>Read Article</span>
                  <svg class="w-4 h-4 transition-transform group-hover/link:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                  </svg>
                </a>
              </div>
            </div>
            <div class="flex items-center justify-center overflow-hidden blog-image-container relative">
              <div class="absolute inset-0 bg-gradient-to-t from-bg/50 to-transparent z-10"></div>
              <Image
                src={image}
                width={700}
                height={700}
                alt={name}
                class="object-cover w-full h-full blog-image transition-transform duration-500 group-hover:scale-110 group-hover:rotate-2"
                loading="lazy"
              />
            </div>
          </div>
        </div>
      );
    })
  }
</Section>

<script>
  async function initBlogAnimations() {
    try {
      const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      if (prefersReducedMotion) return;

      const gsap = (await import('gsap')).default;
      const ScrollTrigger = (await import('gsap/ScrollTrigger')).default;

      gsap.registerPlugin(ScrollTrigger);

      document.querySelectorAll('.blog-card').forEach((card) => {
        // Ensure all blog content is visible by default
        const title = card.querySelector('.blog-title');
        const summary = card.querySelector('.blog-summary');
        const image = card.querySelector('.blog-image');
        const link = card.querySelector('.blog-link');

        gsap.set(card, { opacity: 1, scale: 1 });
        if (title) gsap.set(title, { opacity: 1 });
        if (summary) gsap.set(summary, { opacity: 1 });
        if (image) gsap.set(image, { opacity: 1, scale: 1 });
        if (link) gsap.set(link, { opacity: 1, scale: 1 });

        const tl = gsap.timeline({
          scrollTrigger: {
            trigger: card,
            start: "top 80%",
            toggleActions: "play none none reverse"
          }
        });

        // Card entrance with parallax
        tl.from(card, {
          opacity: 0,
          y: 100,
          scale: 0.9,
          duration: 0.9,
          ease: "power3.out"
        })
        // Title animation with rotation
        .from(title, {
          y: 40,
          opacity: 0,
          rotationX: -45,
          duration: 0.7,
          ease: "back.out(1.7)"
        }, "-=0.5")
        // Summary text wave reveal
        .from(summary, {
          opacity: 0,
          y: 30,
          duration: 0.7,
        }, "-=0.4")
        // Image zoom and slide
        .from(image, {
          scale: 1.4,
          x: 100,
          opacity: 0,
          duration: 1,
          ease: "power2.out"
        }, "-=0.7")
        // Link pop up
        .from(link, {
          scale: 0,
          opacity: 0,
          duration: 0.5,
          ease: "elastic.out(1, 0.5)"
        }, "-=0.3");

        // 3D tilt effect on hover
        card.addEventListener('mousemove', function(e: MouseEvent) {
          const rect = (this as HTMLElement).getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          const rotateX = ((y - centerY) / centerY) * -5;
          const rotateY = ((x - centerX) / centerX) * 5;

          gsap.to(this, {
            rotationX: rotateX,
            rotationY: rotateY,
            duration: 0.3,
            ease: "power2.out",
            transformPerspective: 1000
          });
        });

        card.addEventListener('mouseleave', function() {
          gsap.to(this, {
            rotationX: 0,
            rotationY: 0,
            duration: 0.4,
            ease: "power2.out"
          });
        });
      });
    } catch (error) {
      console.error('Blog animation failed:', error);
      // Ensure all blog content is visible even if animation fails
      const cards = document.querySelectorAll('.blog-card');
      cards.forEach(card => {
        const elements = card.querySelectorAll('.blog-title, .blog-summary, .blog-image, .blog-link');
        (card as HTMLElement).style.opacity = '1';
        elements.forEach(el => {
          (el as HTMLElement).style.opacity = '1';
          (el as HTMLElement).style.visibility = 'visible';
        });
      });
    }
  }

  // Initialize immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBlogAnimations);
  } else {
    initBlogAnimations();
  }
</script>

<style>
  .blog-card {
    transform-style: preserve-3d;
    will-change: transform;
  }
</style>
