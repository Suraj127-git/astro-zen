---
import Section from "./Section.astro";
import type { AboutProps } from "@types";

type Props = AboutProps;

const { description } = Astro.props;
---

<Section text="About Me" href="about">
  <div class="relative max-w-4xl mx-auto">
    <!-- Subtle Background gradient - kept minimal -->
    <div class="absolute -inset-10 bg-gradient-to-r from-primary/5 via-blue-500/5 to-primary/5 blur-3xl opacity-20 pointer-events-none will-change-transform"></div>

    <div class="relative p-8 md:p-12 rounded-3xl border border-border bg-gradient-to-br from-card-bg to-transparent backdrop-blur-sm about-card overflow-hidden will-change-transform">
      
      <div class="flex flex-col items-center text-center">
          
          <div class="text-secondary text-base md:text-lg leading-relaxed about-text space-y-6">
            {description.split('\n\n').map((paragraph: string) => (
              <p class="paragraph will-change-transform">{paragraph.trim()}</p>
            ))}
          </div>

          <!-- Hashtags -->
          <div class="mt-8 flex flex-wrap justify-center gap-3 hashtags">
            {description.match(/#\w+/g)?.map((tag: string) => (
              <span class="px-4 py-2 rounded-full bg-primary/10 border border-primary/30 text-primary text-sm font-medium hashtag hover:bg-primary hover:text-white transition-all duration-300 cursor-default will-change-transform">
                {tag}
              </span>
            ))}
          </div>
      </div>
    </div>
  </div>
</Section>

<script>
  async function initAboutAnimation() {
    try {
      const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      if (prefersReducedMotion) return;

      const gsap = (await import('gsap')).default;
      const ScrollTrigger = (await import('gsap/ScrollTrigger')).default;

      gsap.registerPlugin(ScrollTrigger);

      const aboutSection = document.getElementById('about');
      if (!aboutSection) return;

      // Apply hardware acceleration only within About section
      aboutSection.querySelectorAll('.will-change-transform').forEach(el => {
        (el as HTMLElement).style.transform = 'translateZ(0)';
        (el as HTMLElement).style.willChange = 'transform';
      });

      // Ensure all about content is visible by default
      const card = aboutSection.querySelector('.about-card');
      const paragraphs = aboutSection.querySelectorAll('.paragraph');
      const hashtags = aboutSection.querySelectorAll('.hashtag');

      if (card) gsap.set(card, { opacity: 1, scale: 1 });
      if (paragraphs.length) gsap.set(paragraphs, { opacity: 1 });
      if (hashtags.length) gsap.set(hashtags, { opacity: 1, scale: 1 });

      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: '.about-card',
          start: "top 85%",
          toggleActions: "play none none reverse",
          // Performance optimizations
          fastScrollEnd: true,
        },
        onComplete: () => {
          // Cleanup after animation
          aboutSection.querySelectorAll('.will-change-transform').forEach(el => {
            (el as HTMLElement).style.willChange = 'auto';
          });
        }
      });

      // Optimized card entrance - faster and more subtle
      if (card) {
        tl.from(card, {
          opacity: 0,
          y: 30,
          scale: 0.98,
          duration: 0.4,
          ease: "power2.out"
        });
      }

      // Optimized content animations - quick reveal
      if (paragraphs.length) {
        tl.from(paragraphs, {
          y: 10,
          opacity: 0,
          stagger: 0.05,
          duration: 0.3,
          ease: "power2.out"
        }, "-=0.2");
      }

      if (hashtags.length) {
        tl.from(hashtags, {
          scale: 0.9,
          opacity: 0,
          stagger: 0.02,
          duration: 0.25,
          ease: "back.out(1.2)"
        }, "-=0.15");
      }

    } catch (e) {
      console.error("GSAP animation error:", e);
    }
  }

  // Run on load with cleanup
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAboutAnimation);
  } else {
    initAboutAnimation();
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    try {
      import('gsap').then(({ default: gsap }) => {
        gsap.killTweensOf('.about-card, .paragraph, .hashtag');
      });
    } catch (error) {
      console.error('Animation cleanup error:', error);
    }
  });
</script>