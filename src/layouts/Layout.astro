---
import Header from "@components/Header.astro";
import Loader from "@components/Loader.astro";
import "@fontsource/be-vietnam-pro";
import "@fontsource-variable/gabarito";
import "../styles/global.css";
import { SITE_CONFIG } from "@config";
import Footer from "@components/Footer.astro";

const {
  title,
  description,
  siteLogo,
  navLinks,
  lang,
  author,
  socialLinks,
  socialImage,
  canonicalURL = new URL(Astro.url.pathname, Astro.site).href,
} = SITE_CONFIG;

const ogImgUrl = canonicalURL + socialImage;
---

<!doctype html>
<html lang={lang} class="scroll-smooth scroll-pt-16">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="author" content={author} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- Performance optimizations -->
    <title>{title}</title>

    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={ogImgUrl} />

    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={ogImgUrl} />

    <script type="application/ld+json" is:inline set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Person",
      "name": author,
      "url": canonicalURL,
      "sameAs": socialLinks.map(link => link.href),
      "jobTitle": "Software Engineer",
      "description": description,
      "image": ogImgUrl
    })} />

    <script is:inline>
      // Theme initialization
      const theme = (() => {
        if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
          return localStorage.getItem("theme");
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          return "dark";
        }
        return "light";
      })();
      if (theme === "dark") {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
      window.localStorage.setItem("theme", theme);
    </script>
  </head>
  <body class="font-sans bg-bg text-text overflow-x-hidden transition-colors duration-300">
    <Loader />

    <!-- Custom cursor -->
    <div id="custom-cursor" class="hidden md:block fixed w-5 h-5 rounded-full border-2 border-primary pointer-events-none z-[9999] transition-transform duration-100 ease-out"></div>
    <div id="cursor-dot" class="hidden md:block fixed w-1.5 h-1.5 rounded-full bg-primary pointer-events-none z-[9999]"></div>

    <Header siteLogo={siteLogo} navLinks={navLinks} />
    <main class="max-w-7xl px-4 sm:px-6 md:px-8 lg:px-12 mx-auto w-full" id="main-content">
      <slot />
    </main>
    <Footer author={author} socialLinks={socialLinks} />

<script>
      // Custom cursor with magnetic effect
      async function initCustomCursor() {
        try {
          const gsap = (await import('gsap')).default;
          const cursor = document.getElementById('custom-cursor');
          const cursorDot = document.getElementById('cursor-dot');

          if (!cursor || !cursorDot) return;

          let mouseX = 0;
          let mouseY = 0;
          let cursorX = 0;
          let cursorY = 0;
          let dotX = 0;
          let dotY = 0;

          // Track mouse position
          document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
          });

          // Smooth cursor follow using requestAnimationFrame
          function animateCursor() {
            // Smooth interpolation for main cursor
            cursorX += (mouseX - cursorX) * 0.15;
            cursorY += (mouseY - cursorY) * 0.15;

            // Faster interpolation for dot
            dotX += (mouseX - dotX) * 0.25;
            dotY += (mouseY - dotY) * 0.25;

            gsap.set(cursor, {
              x: cursorX - 10,
              y: cursorY - 10
            });

            gsap.set(cursorDot, {
              x: dotX - 3,
              y: dotY - 3
            });

            requestAnimationFrame(animateCursor);
          }

          animateCursor();

          // Animate cursor on interactive elements
          const interactiveElements = document.querySelectorAll('a, button, input, textarea, [role="button"]');

          interactiveElements.forEach(el => {
            el.addEventListener('mouseenter', () => {
              gsap.to(cursor, { scale: 1.5, duration: 0.3, ease: "back.out(1.7)" });
              gsap.to(cursorDot, { scale: 0, duration: 0.2 });
            });

            el.addEventListener('mouseleave', () => {
              gsap.to(cursor, { scale: 1, duration: 0.3 });
              gsap.to(cursorDot, { scale: 1, duration: 0.2 });
            });
          });

          // Hide default cursor
          document.body.style.cursor = 'none';
          interactiveElements.forEach(el => {
            (el as HTMLElement).style.cursor = 'none';
          });
        } catch (error) {
          console.error('Custom cursor failed:', error);
          // Keep default cursor if custom cursor fails
        }
      }

      if (window.innerWidth >= 768) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCustomCursor);
        } else {
          initCustomCursor();
        }
      }
    </script>
  </body>
</html>
